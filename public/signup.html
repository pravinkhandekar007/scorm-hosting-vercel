<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Sign Up â€“ PlayScorm</title>
  <style>
    /* Your existing styling here */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="main-wrapper">
    <div class="banner">Create Your PlayScorm Account</div>
    <div class="container">
      <h1>Sign Up</h1>
      <form id="signup-form" autocomplete="off">
        <div id="message" class="message"></div>
        <label for="full-name">Full Name</label>
        <input type="text" id="full-name" placeholder="Your full name" required />
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="you@example.com" required />
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Choose a password" required minlength="6" />
        <label for="role">Sign up as</label>
        <select id="role" name="role">
          <option value="learner" selected>Learner</option>
          <option value="owner">Course Owner</option>
        </select>
        <button type="submit" id="signup-button">Sign Up</button>
      </form>
      <p class="footer-text">
        Already have an account? <a href="login.html">Log In</a>
      </p>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const SUPABASE_URL = 'https://mfooewemvofleynanjkb.supabase.co';
      const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY';
      const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      const form = document.getElementById('signup-form');
      const fullNameInput = document.getElementById('full-name');
      const emailInput = document.getElementById('email');
      const pwdInput = document.getElementById('password');
      const roleSelect = document.getElementById('role');
      const message = document.getElementById('message');
      const signupBtn = document.getElementById('signup-button');

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        message.textContent = '';
        message.className = 'message';

        const full_name = fullNameInput.value.trim();
        const email = emailInput.value.trim();
        const password = pwdInput.value;
        const role = roleSelect.value;

        if (!full_name || !email || password.length < 6) {
          message.textContent = 'Full name, valid email and password (min 6 chars) are required.';
          message.classList.add("error");
          return;
        }

        if (!role || (role !== 'learner' && role !== 'owner')) {
          message.textContent = 'Please select a valid role (Learner or Course Owner).';
          message.classList.add("error");
          return;
        }

        signupBtn.disabled = true;
        try {
          // Step 1: Signup user
          const { error: signupError, data } = await supabase.auth.signUp({
            email,
            password,
            options: {
              emailRedirectTo: window.location.origin + '/email-verified.html'
            }
          });

          if (signupError) {
            message.textContent = signupError.message;
            message.classList.add("error");
            signupBtn.disabled = false;
            return;
          }

          // Step 2: Wait for user to propagate (delay)
          await new Promise(resolve => setTimeout(resolve, 3000));

          // Step 3: Create profile with role immediately after signup
          const profilePayload = {
            action: 'create-profile',
            user_id: data.user.id,
            email: data.user.email,
            full_name: full_name,
            role: role
          };

          const createProfileRes = await fetch('/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(profilePayload)
          });

          const resultJson = await createProfileRes.json();

          if (createProfileRes.ok || createProfileRes.status === 409) {
            message.textContent = `Signup succeeded! Please check your email (${email}) to verify your account.`;
            message.classList.add("success");
            form.reset();
          } else if (createProfileRes.status === 404) {
            message.textContent = 'User propagation delay. Please retry after a moment.';
            message.classList.add("error");
          } else {
            message.textContent = `Signup failed: ${resultJson.error || 'Unknown error'}`;
            message.classList.add("error");
          }
        }
        catch (err) {
          message.textContent = `Error: ${err.message}`;
          message.classList.add("error");
        } finally {
          signupBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>
