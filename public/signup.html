// In the form submit handler, change Step 2 and 3:

// Step 2: Wait longer for user to propagate
console.log('Step 2: Waiting 3 seconds for user propagation...');
await new Promise(resolve => setTimeout(resolve, 3000));

// Step 3: Call backend API to create profile
console.log('Step 3: Calling /api/signup to create profile with role');
const profilePayload = {
  action: 'create-profile',
  user_id: data.user.id,
  email: data.user.email,
  full_name: full_name,
  role: role
};

console.log('Profile payload being sent:', profilePayload);

const createProfileRes = await fetch('/api/signup', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify(profilePayload)
});

const resultJson = await createProfileRes.json();
console.log('Profile creation response status:', createProfileRes.status);
console.log('Profile creation response:', resultJson);

// If user not found (404), retry
if (createProfileRes.status === 404) {
  console.log('User not found yet, retrying in 2 seconds...');
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  const retryRes = await fetch('/api/signup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(profilePayload)
  });
  
  const retryJson = await retryRes.json();
  console.log('Retry response status:', retryRes.status);
  console.log('Retry response:', retryJson);
  
  if (retryRes.ok || retryRes.status === 409) {
    message.textContent = `Signup successful! Please check your email (${email}) to verify your account.`;
    message.classList.add("success");
    form.reset();
    return;
  } else {
    throw new Error(retryJson.error || 'Failed to create profile after retry');
  }
}

if (createProfileRes.ok || createProfileRes.status === 409) {
  message.textContent = `Signup successful! Please check your email (${email}) to verify your account.`;
  message.classList.add("success");
  form.reset();
} else {
  throw new Error(resultJson.error || 'Failed to create profile');
}
