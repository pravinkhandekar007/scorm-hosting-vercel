<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <title>Sign Up â€“ Playscorm</title>
  <style>
    /* ... existing styles ... */
    body {
      margin: 0;
      min-height: 100vh;
      background: #C0C0C0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .main-wrapper {
      width: 100%;
      max-width: 600px;
    }
    /* rest of your existing styles... */
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="main-wrapper">
    <div class="banner">Create Your PlayScorm Account</div>
    <div class="container">
      <h1>Sign Up</h1>
      <form id="signup-form" autocomplete="off">
        <div id="message" class="message"></div>
        <label for="full-name">Full Name</label>
        <input type="text" id="full-name" placeholder="Your full name" required />
        <label for="email">Email Address</label>
        <input type="email" id="email" placeholder="you@example.com" required />
        <label for="password">Password</label>
        <input type="password" id="password" placeholder="Choose a password" required minlength="6" />
        <label for="role">Sign up as</label>
        <select id="role" name="role">
          <option value="learner" selected>Learner</option>
          <option value="owner">Course Owner</option>
        </select>
        <button type="submit" id="signup-button">Sign Up</button>
      </form>
      <p class="footer-text">
        Already have an account? <a href="login.html">Log In</a>
      </p>
    </div>
  </div>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const SUPABASE_URL = 'https://mfooewemvofleynanjkb.supabase.co';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE'; // replace with your actual key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const form = document.getElementById('signup-form');
    const fullNameInput = document.getElementById('full-name');
    const emailInput = document.getElementById('email');
    const pwdInput = document.getElementById('password');
    const roleSelect = document.getElementById('role');
    const message = document.getElementById('message');
    const signupBtn = document.getElementById('signup-button');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      message.textContent = '';
      message.className = 'message';

      const full_name = fullNameInput.value.trim();
      const email = emailInput.value.trim();
      const password = pwdInput.value;
      const role = roleSelect.value || 'learner';

      console.log('Signup data:', { email, full_name, role }); // Debug log

      if (!full_name || !email || password.length < 6) {
        message.textContent = 'Full name, valid email, and password (min 6 chars) are required.';
        message.classList.add("error");
        return;
      }

      signupBtn.disabled = true;
      try {
        const { error, data } = await supabase.auth.signUp({
          email,
          password,
          options: {
            emailRedirectTo: 'https://playscorm.com/email-verified.html'
          }
        });

        if (error) {
          message.textContent = error.message;
          message.classList.add("error");
        } else {
          // Log the role being sent
          console.log('Creating profile with role:', role);

          // Call your API to create profile with role
          const createProfileRes = await fetch('/api/signup', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              action: 'create-profile',
              user_id: data.user.id,
              email: data.user.email,
              full_name,
              role
            })
          });

          const resultJson = await createProfileRes.json();
          if (!createProfileRes.ok) {
            console.error('Profile creation error response:', resultJson);
            if (createProfileRes.status === 409) {
              // Profile already exists, treat as success
              message.textContent = `Signup successful! Please check your email (${email}) to confirm your account.`;
              message.classList.add("success");
              form.reset();
            } else {
              throw new Error(resultJson.error || 'Failed to create profile.');
            }
          } else {
            // Success
            message.textContent = `Signup successful! Please check your email (${email}) to confirm your account.`;
            message.classList.add("success");
            form.reset();
          }
        }
      } catch (err) {
        message.textContent = 'Unexpected error occurred. Please try again.';
        message.classList.add("error");
      } finally {
        signupBtn.disabled = false;
      }
    });
  });
</script>
</body>
</html>
