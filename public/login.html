<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="description" content="PlayScorm - Cloud-based SCORM player and LMS for e-learning. Upload, manage, and launch SCORM 1.2 and SCORM 2004 courses with ease. Secure, fast, and scalable learning management system.">
<meta name="keywords" content="SCORM player, SCORM LMS, e-learning platform, learning management system, SCORM 1.2, SCORM 2004, online training, course authoring, AICC, xAPI, Tin Can API, interactive learning, corporate training, distance learning, SCORM compliance">
<meta name="author" content="PlayScorm">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login - PlayScorm | SCORM Player & E-Learning Platform</title>
<style>
  /* (Your existing styles unchanged for brevity) */
  /* - Skipped here - */
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <div class="main-wrapper">
    <div class="banner">Welcome to PlayScorm</div>
    <div class="container">
      <div class="left-panel">
        <div class="form-container">
          <h1>Login to Your Account</h1>
          <div id="error-message" class="error-message"></div>
          <form id="login-form" autocomplete="off">
            <label for="email">Email Address</label>
            <input type="email" id="email" placeholder="you@example.com" required />

            <label for="password">Password</label>
            <input type="password" id="password" placeholder="Your password" required />

            <button type="submit" id="login-button" disabled>Sign In</button>
          </form>
          <div class="form-footer">
            New to PlayScorm? <a href="signup.html">Sign Up</a><br />
            <a href="forgot-password.html">Forgot Password?</a>
          </div>
        </div>
      </div>
      <div class="right-panel">
        <!-- (Your descriptive content unchanged for brevity) -->
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = 'https://mfooewemvofleynanjkb.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mb29ld2Vtdm9mbGV5bmFuamtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyOTUwMjYsImV4cCI6MjA3NDg3MTAyNn0.EFvtSe-k-SPDCf1-1py6ev7nBLDJFCrNgZ95_c29_ZY';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const loginButton = document.getElementById('login-button');
    const errorMessage = document.getElementById('error-message');

    function validateInputs() {
      loginButton.disabled = !(emailInput.value.trim() && passwordInput.value.trim());
    }

    emailInput.addEventListener('input', validateInputs);
    passwordInput.addEventListener('input', validateInputs);

    document.getElementById('login-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMessage.textContent = '';
      loginButton.disabled = true;
      loginButton.textContent = 'Signing in...';

      const email = emailInput.value.trim();
      const password = passwordInput.value;

      try {
        const { error, data: supabaseUser } = await supabase.auth.signInWithPassword({ email, password });
        if (error) {
          errorMessage.textContent = error.message;
          loginButton.disabled = false;
          loginButton.textContent = 'Sign In';
          return;
        }

        const user = supabaseUser.user;

        // Fetch the profile to get role
        const profileRes = await fetch(`/api/profiles?id=${user.id}`);
        const profileData = await profileRes.json();

        if (!profileRes.ok || !profileData || profileData.length === 0) {
          errorMessage.textContent = 'User profile missing. Contact support.';
          loginButton.disabled = false;
          loginButton.textContent = 'Sign In';
          return;
        }

        const userRole = profileData[0].role || 'learner';

        // Redirect based on role
        if (userRole === 'owner') {
          window.location.href = 'owner-dashboard.html';
        } else if (userRole === 'admin') {
          window.location.href = 'admin-dashboard.html';
        } else {
          window.location.href = 'dashboard.html';
        }

      } catch (err) {
        errorMessage.textContent = 'Unexpected error occurred.';
        loginButton.disabled = false;
        loginButton.textContent = 'Sign In';
      }
    });

    validateInputs();
  </script>
</body>
</html>
