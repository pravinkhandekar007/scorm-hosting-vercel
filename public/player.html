<script>
const SUPABASE_URL = 'https://mfooewemvofleynanjkb.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mb29ld2Vtdm9mbGV5bmFuamtiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkyOTUwMjYsImV4cCI6MjA3NDg3MTAyNn0.EFvtSe-k-SPDCf1-1py6ev7nBLDJFCrNgZ95_c29_ZY';
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

(async () => {
  const msg = document.getElementById('message');
  const frame = document.getElementById('courseFrame');
  const params = new URLSearchParams(window.location.search);
  const courseSlug = params.get('course');
  const publicId = params.get('public_id');
  
  let courseEndpoint = '';
  let headers = {};

  if (publicId) {
    // Public access - no authentication required
    courseEndpoint = `/api/get-course-by-public-id?public_id=${encodeURIComponent(publicId)}`;
    msg.textContent = 'Loading public course...';
  } else if (courseSlug) {
    // Private access - requires authentication
    msg.textContent = 'Checking authentication...';
    
    const { data: { session } } = await supabase.auth.getSession();
    if (!session) {
      msg.textContent = 'Authentication required. Redirecting to login...';
      setTimeout(() => {
        window.location.href = 'login.html';
      }, 2000);
      return;
    }
    
    headers['Authorization'] = `Bearer ${session.access_token}`;
    courseEndpoint = `/api/get-course?slug=${encodeURIComponent(courseSlug)}`;
    msg.textContent = 'Loading private course...';
  } else {
    msg.textContent = 'Error: Missing course parameter.';
    return;
  }

  try {
    const res = await fetch(courseEndpoint, { headers });
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('Fetch error:', res.status, errorText);
      throw new Error(`HTTP ${res.status}: ${errorText}`);
    }
    
    const course = await res.json();
    
    if (course.error) {
      throw new Error(course.error);
    }
    
    const proxyBaseUrl = `/scorm-content/${course.package_path}/`;

    msg.textContent = 'Loading course content...';

    // Try to get launch file from manifest
    let launchFile = course.launch_url || 'index.html';
    
    try {
      const mf = await fetch(proxyBaseUrl + 'imsmanifest.xml');
      if (mf.ok) {
        const manifestText = await mf.text();
        const xml = new DOMParser().parseFromString(manifestText, 'application/xml');
        const resource = xml.querySelector('resource[href]');
        if (resource) {
          launchFile = resource.getAttribute('href');
        }
      }
    } catch (manifestError) {
      console.log('Could not load manifest, using default launch file');
    }

    msg.textContent = 'Starting course...';

    frame.src = proxyBaseUrl + launchFile;
    frame.style.display = 'block';
    msg.style.display = 'none';
    
  } catch (err) {
    console.error('Course loading error:', err);
    msg.textContent = `Failed to load course: ${err.message}`;
    frame.style.display = 'none';
  }
})();
</script>
